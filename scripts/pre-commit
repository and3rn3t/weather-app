#!/bin/sh
# Andernet Weather - Pre-commit Hook
# This hook runs before each commit to ensure code quality
#
# To install, run from project root:
#   cp scripts/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

echo "ğŸ” Running pre-commit checks..."

# Get the list of staged Swift files
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.swift$")

if [ -z "$STAGED_SWIFT_FILES" ]; then
    echo "âœ… No Swift files to check"
    exit 0
fi

# Check if SwiftLint is installed
if command -v swiftlint > /dev/null 2>&1; then
    echo "ğŸ“‹ Running SwiftLint..."
    
    # Run SwiftLint only on staged files
    echo "$STAGED_SWIFT_FILES" | while read file; do
        if [ -f "$file" ]; then
            swiftlint lint --quiet --path "$file" --config .swiftlint.yml
            LINT_RESULT=$?
            if [ $LINT_RESULT -ne 0 ]; then
                echo "âŒ SwiftLint found issues in: $file"
            fi
        fi
    done
else
    echo "âš ï¸  SwiftLint not installed. Skipping lint check."
    echo "   Install with: brew install swiftlint"
fi

# Check for common issues
echo "ğŸ” Checking for common issues..."

# Check for print statements (should use os_log in production)
PRINT_COUNT=$(echo "$STAGED_SWIFT_FILES" | xargs grep -l "print(" 2>/dev/null | wc -l | tr -d ' ')
if [ "$PRINT_COUNT" -gt "0" ]; then
    echo "âš ï¸  Warning: Found print() statements in $PRINT_COUNT file(s)"
    echo "   Consider using os_log for production logging"
fi

# Check for force unwraps (!)
FORCE_UNWRAP=$(echo "$STAGED_SWIFT_FILES" | xargs grep -n "![^=]" 2>/dev/null | grep -v "// swiftlint:disable" | head -5)
if [ -n "$FORCE_UNWRAP" ]; then
    echo "âš ï¸  Warning: Potential force unwraps detected:"
    echo "$FORCE_UNWRAP"
fi

# Check for TODO/FIXME comments
TODO_COUNT=$(echo "$STAGED_SWIFT_FILES" | xargs grep -c "TODO\|FIXME" 2>/dev/null | awk -F: '{sum += $2} END {print sum}')
if [ "$TODO_COUNT" -gt "0" ]; then
    echo "ğŸ“ Note: Found $TODO_COUNT TODO/FIXME comment(s)"
fi

echo "âœ… Pre-commit checks complete"
exit 0
