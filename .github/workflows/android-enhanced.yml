# Optimized Android CI/CD
# Matrix builds, advanced caching, and smart test execution

name: Android Enhanced

on:
  push:
    branches: [main]
    paths:
      - 'android-app/**'
      - '.github/workflows/android-enhanced.yml'
  pull_request:
    branches: [main]
    paths:
      - 'android-app/**'

concurrency:
  group: android-enhanced-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '17'
  GRADLE_OPTS: >-
    -Dorg.gradle.daemon=false
    -Dorg.gradle.configureondemand=true
    -Dorg.gradle.parallel=true
    -Dorg.gradle.caching=true
    -Dorg.gradle.workers.max=4
    -Xmx4g

jobs:
  # Pre-checks and change detection
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      app-code: ${{ steps.changes.outputs.app-code }}
      tests: ${{ steps.changes.outputs.tests }}
      gradle-config: ${{ steps.changes.outputs.gradle-config }}
      significant-changes: ${{ steps.changes.outputs.significant-changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect File Changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app-code:
              - 'android-app/app/src/main/**'
            tests:
              - 'android-app/app/src/test/**'
              - 'android-app/app/src/androidTest/**'
            gradle-config:
              - 'android-app/**/*.gradle*'
              - 'android-app/gradle.properties'
            significant-changes:
              - added|modified: 'android-app/**/*.kt'
              - added|modified: 'android-app/**/*.java'
        
      - name: Change Summary
        run: |
          echo "### ðŸ” Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| App Code | ${{ steps.changes.outputs.app-code == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.changes.outputs.tests == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gradle Config | ${{ steps.changes.outputs.gradle-config == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY

  # Fast feedback loop (lint + quick compile)
  quick-check:
    name: Quick Check
    runs-on: ubuntu-latest-4-cores
    needs: changes
    timeout-minutes: 8

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Gradle Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: android-gradle-${{ hashFiles('android-app/**/*.gradle*', 'android-app/gradle.properties', 'android-app/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            android-gradle-

      - name: Lint & Quick Compile
        working-directory: android-app
        run: |
          # Run lint and compile check in parallel
          ./gradlew lintDebug compileDebugKotlin \
            --parallel \
            --build-cache \
            --configuration-cache

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: android-app/app/build/reports/lint-results-*.html
          retention-days: 3

  # Matrix build and test strategy
  test-matrix:
    name: Test (${{ matrix.variant }}, API ${{ matrix.api-level }})
    runs-on: ubuntu-latest-8-cores  # More cores for parallel testing
    needs: [changes, quick-check]
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        variant: [Debug, Release]
        api-level: [26, 30, 34]
        include:
          # Full test suite for Debug/API 30 (most common)
          - variant: Debug
            api-level: 30
            test-suite: full
            coverage: true
            
          # Quick tests for other combinations
          - variant: Debug
            api-level: 26
            test-suite: unit
            coverage: false
            
          - variant: Debug  
            api-level: 34
            test-suite: unit
            coverage: false
            
          # Release builds only on significant changes
          - variant: Release
            api-level: 30  
            test-suite: unit
            coverage: false
            condition: needs.changes.outputs.significant-changes == 'true'

    steps:
      - name: Skip Conditional Jobs
        if: matrix.condition && matrix.condition != 'true'
        run: |
          echo "â­ï¸ Skipping ${{ matrix.variant }} (API ${{ matrix.api-level }}) - condition not met"
          exit 0

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK  
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      # Advanced caching with variant-specific keys
      - name: Gradle Cache (Variant-Specific)
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: android-${{ matrix.variant }}-api${{ matrix.api-level }}-${{ hashFiles('android-app/**/*.gradle*') }}
          restore-keys: |
            android-${{ matrix.variant }}-api${{ matrix.api-level }}-
            android-${{ matrix.variant }}-
            android-

      - name: AVD Cache
        if: matrix.test-suite == 'full'
        uses: actions/cache@v4
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-api${{ matrix.api-level }}-${{ runner.arch }}
          restore-keys: |
            avd-api${{ matrix.api-level }}-

      - name: Build ${{ matrix.variant }}
        working-directory: android-app
        run: |
          BUILD_START_TIME=$(date +%s)
          
          if [[ "${{ matrix.variant }}" == "Release" ]]; then
            ./gradlew assembleRelease \
              --parallel \
              --build-cache \
              --configuration-cache
          else
            ./gradlew assembleDebug \
              --parallel \
              --build-cache \
              --configuration-cache
          fi
          
          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          echo "build_duration=$BUILD_DURATION" >> $GITHUB_OUTPUT
          echo "### ðŸ”¨ Build (${{ matrix.variant }}) completed in ${BUILD_DURATION}s" >> $GITHUB_STEP_SUMMARY

      - name: Unit Tests
        working-directory: android-app
        run: |
          TEST_START_TIME=$(date +%s)
          
          COVERAGE_FLAG=""
          if [[ "${{ matrix.coverage }}" == "true" ]]; then
            COVERAGE_FLAG="--continue"
          fi
          
          ./gradlew test${{ matrix.variant }}UnitTest \
            --parallel \
            --build-cache \
            $COVERAGE_FLAG
          
          TEST_END_TIME=$(date +%s)  
          TEST_DURATION=$((TEST_END_TIME - TEST_START_TIME))
          echo "test_duration=$TEST_DURATION" >> $GITHUB_OUTPUT
          echo "### ðŸ§ª Unit tests completed in ${TEST_DURATION}s" >> $GITHUB_STEP_SUMMARY

      - name: Integration Tests (Emulator)  
        if: matrix.test-suite == 'full'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          cores: 2
          ram-size: 4096M
          heap-size: 2048M
          script: |
            cd android-app
            ./gradlew connectedDebugAndroidTest \
              --parallel \
              --build-cache

      - name: Generate Coverage Report
        if: matrix.coverage == true
        working-directory: android-app  
        run: |
          ./gradlew jacocoTestReport
          
          # Extract coverage percentage
          COVERAGE_FILE="app/build/reports/jacoco/jacocoTestReport/html/index.html"
          if [[ -f "$COVERAGE_FILE" ]]; then
            COVERAGE_PERCENT=$(grep -o 'Total.*[0-9]\+%' "$COVERAGE_FILE" | grep -o '[0-9]\+%' | head -1)
            echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
            echo "### ðŸ“Š Test Coverage: $COVERAGE_PERCENT" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.variant }}-api${{ matrix.api-level }}
          path: |
            android-app/app/build/test-results/**/*.xml
            android-app/app/build/reports/tests/
            android-app/app/build/reports/jacoco/
            android-app/app/build/reports/androidTests/connected/
          retention-days: ${{ github.ref == 'refs/heads/main' && 14 || 3 }}
          compression-level: 6

      - name: Upload APK/AAB
        if: matrix.variant == 'Release'
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.variant }}-api${{ matrix.api-level }}
          path: |
            android-app/app/build/outputs/apk/**/*.apk
            android-app/app/build/outputs/bundle/**/*.aab
          retention-days: 30

  # Performance and size analysis  
  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: test-matrix
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin' 
          java-version: ${{ env.JAVA_VERSION }}

      - name: Performance Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: android-perf-${{ hashFiles('android-app/**/*.gradle*') }}
          restore-keys: |
            android-perf-
            android-

      - name: Build Analysis
        working-directory: android-app
        run: |
          # Generate build scan
          ./gradlew assembleRelease \
            --scan \
            --profile \
            --build-cache
          
          # Analyze build performance
          echo "### ðŸ“ˆ Build Performance Analysis" >> $GITHUB_STEP_SUMMARY
          
          # Extract build times from reports
          if [[ -d "build/reports/profile" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Build Profile Generated** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "Check build/reports/profile for detailed analysis" >> $GITHUB_STEP_SUMMARY
          fi

      - name: APK Size Analysis
        working-directory: android-app
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
          if [[ -f "$APK_PATH" ]]; then
            APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "### ðŸ“¦ APK Size Analysis" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY  
            echo "| APK Size | $APK_SIZE |" >> $GITHUB_STEP_SUMMARY
            
            # Detailed size breakdown using aapt
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Size Breakdown:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            aapt dump badging "$APK_PATH" | grep "native-code" >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # Security and dependency checks
  security-check:
    name: Security Analysis  
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.gradle-config == 'true' || github.event_name == 'push'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Dependency Check
        working-directory: android-app
        run: |
          ./gradlew dependencyUpdates
          
          # Check for known vulnerabilities
          ./gradlew dependencyCheckAnalyze || true

      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            android-app/build/reports/dependencyUpdates/
            android-app/build/reports/dependency-check-report.html
          retention-days: 7

  # Final status aggregation
  android-ci-complete:
    name: Android CI Complete
    runs-on: ubuntu-latest
    needs: [test-matrix, performance-analysis, security-check]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Aggregate Results
        run: |
          # Check overall success
          if [[ "${{ needs.test-matrix.result }}" == "success" ]]; then
            echo "âœ… Android Enhanced CI completed successfully!"
            
            echo "### ðŸŽ‰ Android Enhanced CI - Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Matrix Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… All build variants completed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Unit tests passed across API levels" >> $GITHUB_STEP_SUMMARY  
            echo "- âœ… Integration tests completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Optimizations Active:**" >> $GITHUB_STEP_SUMMARY
            echo "- âš¡ Variant-specific caching" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŽ¯ Change-based job execution" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“Š Performance tracking" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”’ Security analysis" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Android Enhanced CI failed"
            echo "### âŒ Android Enhanced CI - Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please check the matrix job logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi